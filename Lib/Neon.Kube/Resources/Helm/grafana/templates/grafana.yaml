apiVersion: integreatly.org/v1alpha1
kind: Grafana
metadata:
  name: grafana
spec:
  ingress:
    enabled: False
  config:
    security:
      disable_brute_force_login_protection: true
    log:
      mode: "console"
      level: "debug"
    auth.generic_oauth:
      api_url: >-
        https://sso.{{ .Values.cluster.domain }}/auth/realms/neon-sso/protocol/openid-connect/userinfo
      auth_url: >-
        https://sso.{{ .Values.cluster.domain }}/auth/realms/neon-sso/protocol/openid-connect/auth
      client_id: $__env{CLIENT_ID}
      client_secret: $__env{CLIENT_SECRET}
      empty_scopes: false
      enabled: true
      scopes: openid
      token_url: >-
        https://sso.{{ .Values.cluster.domain }}/auth/realms/neon-sso/protocol/openid-connect/token
      role_attribute_path: >-
        contains(roles[*], 'admin') && 'Admin' || contains(roles[*], 'editor')
        && 'Editor' || 'Viewer'
    database:
      type: postgres
      host: db-citus-postgresql.neon-system.svc.cluster.local
      name: grafana
      user: neon_service
      password: $__env{DATABASE_PASSWORD}
  service:
    name: "grafana"
    labels:
      app: "grafana"
      type: "grafana-service"
    type: NodePort
    ports:
      - name: grafana-nodeport
        protocol: TCP
        port: 3001
        nodePort: 30001
        targetPort: grafana-http
  deployment:
    annotations:
      reloader.stakater.com/search: "true"
    envFrom:
      - secretRef:
          name: grafana-db-password
      - secretRef:
          name: keycloak-client-secret-grafana
   
    nodeSelector:
      {{- toYaml .Values.nodeSelector | nindent 8 }}
  dashboardLabelSelector:
    - matchExpressions:
        - { key: app, operator: In, values: [ grafana ] }
  # initResources:
  #   # Optionally specify initResources
  #   limits:
  #     cpu: 1000m
  #     memory: 512Mi
  #   requests:
  #     cpu: 250m
  #     memory: 128Mi
  resources:
    # Optionally specify container resources
    limits:
      memory: {{ .Values.resources.limits.memory }}
    requests:
      memory: {{ .Values.resources.requests.memory }}
